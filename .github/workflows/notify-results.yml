name: Notify Results

on:
  workflow_call:
    inputs:
      action:
        description: "AÃ§Ã£o executada (release/patch)"
        required: true
        type: string
      version:
        description: "VersÃ£o processada"
        required: true
        type: string
      change_type:
        description: "Tipo de mudanÃ§a"
        required: true
        type: string
      release_success:
        description: "Release foi bem-sucedida"
        required: true
        type: boolean
      patch_success:
        description: "Patch foi bem-sucedido"
        required: true
        type: boolean
      version_updated:
        description: "VersÃ£o foi atualizada"
        required: true
        type: boolean

jobs:
  notify:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate Execution Summary
        id: summary
        shell: powershell
        run: |
          $action = "${{ inputs.action }}"
          $version = "${{ inputs.version }}"
          $changeType = "${{ inputs.change_type }}"
          $releaseSuccess = "${{ inputs.release_success }}"
          $patchSuccess = "${{ inputs.patch_success }}"
          $versionUpdated = "${{ inputs.version_updated }}"
          
          Write-Output "ğŸ“Š Gerando resumo da execuÃ§Ã£o..."
          
          # Determinar status geral
          $overallSuccess = $false
          $primaryAction = ""
          $statusIcon = ""
          $statusMessage = ""
          
          if ($action -eq "release") {
            $overallSuccess = ($releaseSuccess -eq "true")
            $primaryAction = "RELEASE"
            $statusIcon = if ($overallSuccess) { "ğŸš€" } else { "âŒ" }
            $statusMessage = if ($overallSuccess) { "Release criada com sucesso" } else { "Falha na criaÃ§Ã£o da release" }
          } elseif ($action -eq "patch") {
            $overallSuccess = ($patchSuccess -eq "true")
            $primaryAction = "PATCH"
            $statusIcon = if ($overallSuccess) { "ğŸ”§" } else { "âŒ" }
            $statusMessage = if ($overallSuccess) { "Patch criado com sucesso" } else { "Falha na criaÃ§Ã£o do patch" }
          } else {
            $primaryAction = "UNKNOWN"
            $statusIcon = "â“"
            $statusMessage = "AÃ§Ã£o desconhecida"
          }
          
          # Calcular emoji do tipo de mudanÃ§a
          $changeTypeEmoji = switch ($changeType) {
            "major" { "ğŸ’¥" }
            "minor" { "âœ¨" }
            "patch" { "ğŸ›" }
            default { "ğŸ“" }
          }
          
          # Gerar timestamp
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          $branch = "${{ github.ref_name }}"
          $actor = "${{ github.actor }}"
          $runId = "${{ github.run_id }}"
          
          # Set outputs para uso posterior
          echo "overall-success=$overallSuccess" >> $env:GITHUB_OUTPUT
          echo "primary-action=$primaryAction" >> $env:GITHUB_OUTPUT
          echo "status-icon=$statusIcon" >> $env:GITHUB_OUTPUT
          echo "status-message=$statusMessage" >> $env:GITHUB_OUTPUT
          echo "change-type-emoji=$changeTypeEmoji" >> $env:GITHUB_OUTPUT
          echo "timestamp=$timestamp" >> $env:GITHUB_OUTPUT
          
          Write-Output "ğŸ“‹ Resumo gerado:"
          Write-Output "  Status geral: $overallSuccess"
          Write-Output "  AÃ§Ã£o principal: $primaryAction"
          Write-Output "  Mensagem: $statusMessage"

      - name: Display Pipeline Results
        shell: powershell
        run: |
          $action = "${{ inputs.action }}"
          $version = "${{ inputs.version }}"
          $changeType = "${{ inputs.change_type }}"
          $statusIcon = "${{ steps.summary.outputs.status-icon }}"
          $statusMessage = "${{ steps.summary.outputs.status-message }}"
          $changeTypeEmoji = "${{ steps.summary.outputs.change-type-emoji }}"
          $timestamp = "${{ steps.summary.outputs.timestamp }}"
          $overallSuccess = "${{ steps.summary.outputs.overall-success }}"
          
          Write-Output ""
          Write-Output "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Output "â•‘                     PIPELINE CONCLUÃDA                      â•‘"
          Write-Output "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Output ""
          Write-Output "$statusIcon RESULTADO: $statusMessage"
          Write-Output ""
          Write-Output "ğŸ“‹ DETALHES DA EXECUÃ‡ÃƒO:"
          Write-Output "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          Write-Output "â”‚  ğŸ¯ AÃ§Ã£o:           $action (${{ steps.summary.outputs.primary-action }})"
          Write-Output "â”‚  ğŸ“± VersÃ£o:         $version"
          Write-Output "â”‚  $changeTypeEmoji Tipo:           $changeType"
          Write-Output "â”‚  ğŸŒŸ Branch:         ${{ github.ref_name }}"
          Write-Output "â”‚  ğŸ‘¤ Executor:       ${{ github.actor }}"
          Write-Output "â”‚  â° Timestamp:      $timestamp"
          Write-Output "â”‚  ğŸ”— Run ID:         ${{ github.run_id }}"
          Write-Output "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          Write-Output ""
          Write-Output "ğŸ” STATUS DETALHADO:"
          Write-Output "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          Write-Output "â”‚  ğŸ“ Versionamento:  $(if ("${{ inputs.version_updated }}" -eq "true") { "âœ… Atualizado" } else { "â„¹ï¸  NÃ£o necessÃ¡rio" })"
          Write-Output "â”‚  ğŸš€ Release:        $(if ("${{ inputs.release_success }}" -eq "true") { "âœ… Criada" } elseif ("$action" -eq "release") { "âŒ Falhou" } else { "â– N/A" })"
          Write-Output "â”‚  ğŸ”§ Patch:          $(if ("${{ inputs.patch_success }}" -eq "true") { "âœ… Criado" } elseif ("$action" -eq "patch") { "âŒ Falhou" } else { "â– N/A" })"
          Write-Output "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          
          if ($overallSuccess -eq "true") {
            Write-Output ""
            Write-Output "ğŸ‰ SUCESSO TOTAL!"
            Write-Output ""
            
            if ($action -eq "release") {
              Write-Output "ğŸ“¦ RELEASE DISTRIBUÃDA:"
              Write-Output "  âœ… Nova release base disponÃ­vel no Shorebird"
              Write-Output "  âœ… Futuras atualizaÃ§Ãµes serÃ£o patches baseados nesta release"
              Write-Output "  âœ… UsuÃ¡rios podem baixar nova versÃ£o completa"
              Write-Output "  âœ… GitHub release criada com documentaÃ§Ã£o"
              Write-Output ""
              Write-Output "ğŸ“‹ PrÃ³ximos passos:"
              Write-Output "  1. ğŸ“Š Monitorar adoÃ§Ã£o da nova release"
              Write-Output "  2. ğŸ”§ Patches futuros serÃ£o baseados na v$version"
              Write-Output "  3. ğŸ“± Testar atualizaÃ§Ã£o em dispositivos"
              Write-Output "  4. ğŸ“ˆ Acompanhar mÃ©tricas de performance"
              
            } elseif ($action -eq "patch") {
              Write-Output "ğŸ”§ PATCH DISTRIBUÃDO:"
              Write-Output "  âœ… Patch disponÃ­vel no Shorebird"
              Write-Output "  âœ… UsuÃ¡rios receberÃ£o update automÃ¡tico"
              Write-Output "  âœ… AtualizaÃ§Ã£o incremental (download menor)"
              Write-Output "  âœ… Rollback automÃ¡tico disponÃ­vel se necessÃ¡rio"
              Write-Output ""
              Write-Output "ğŸ“‹ PrÃ³ximos passos:"
              Write-Output "  1. â³ Aguardar propagaÃ§Ã£o (5-10 minutos)"
              Write-Output "  2. ğŸ“± Testar update em dispositivo com app instalado"
              Write-Output "  3. ğŸ“Š Monitorar logs de update dos usuÃ¡rios"
              Write-Output "  4. ğŸ” Verificar ausÃªncia de crashes/bugs"
            }
            
          } else {
            Write-Output ""
            Write-Output "âŒ PIPELINE FALHOU!"
            Write-Output ""
            Write-Output "ğŸ” POSSÃVEIS CAUSAS:"
            
            if ($action -eq "release" -and "${{ inputs.release_success }}" -eq "false") {
              Write-Output "  â€¢ Erro na criaÃ§Ã£o da release Shorebird"
              Write-Output "  â€¢ Problema de configuraÃ§Ã£o/autenticaÃ§Ã£o"
              Write-Output "  â€¢ Release com esta versÃ£o jÃ¡ existe"
              Write-Output "  â€¢ Falha na compilaÃ§Ã£o Flutter"
            } elseif ($action -eq "patch" -and "${{ inputs.patch_success }}" -eq "false") {
              Write-Output "  â€¢ Erro na criaÃ§Ã£o do patch Shorebird"
              Write-Output "  â€¢ MudanÃ§as incompatÃ­veis com patch"
              Write-Output "  â€¢ Release base nÃ£o encontrada"
              Write-Output "  â€¢ Problema de compilaÃ§Ã£o"
            }
            
            Write-Output ""
            Write-Output "ğŸ› ï¸ AÃ‡Ã•ES RECOMENDADAS:"
            Write-Output "  1. ğŸ“‹ Revisar logs detalhados acima"
            Write-Output "  2. ğŸ” Verificar configuraÃ§Ã£o: shorebird doctor"
            Write-Output "  3. ğŸ”§ Corrigir problemas identificados"
            Write-Output "  4. ğŸ”„ Re-executar pipeline manualmente"
            Write-Output "  5. ğŸ’¬ Buscar ajuda se necessÃ¡rio"
          }
          
          Write-Output ""
          Write-Output "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Output "â•‘              FIM DO RESUMO DA PIPELINE                       â•‘"
          Write-Output "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Create Issue on Failure
        if: steps.summary.outputs.overall-success == 'false'
        shell: powershell
        run: |
          Write-Output "ğŸš¨ Criando issue automÃ¡tica para falha na pipeline..."
          
          $action = "${{ inputs.action }}"
          $version = "${{ inputs.version }}"
          $changeType = "${{ inputs.change_type }}"
          $runId = "${{ github.run_id }}"
          $branch = "${{ github.ref_name }}"
          $actor = "${{ github.actor }}"
          $timestamp = "${{ steps.summary.outputs.timestamp }}"
          
          # Preparar tÃ­tulo da issue
          $issueTitle = "ğŸš¨ Pipeline Failure: $action for v$version"
          
          # Preparar corpo da issue
          $issueBody = @"
          # ğŸš¨ Falha AutomÃ¡tica na Pipeline
          
          **Pipeline falhou durante execuÃ§Ã£o automÃ¡tica.**
          
          ## ğŸ“‹ Detalhes da Falha
          
          - **AÃ§Ã£o:** $action
          - **VersÃ£o:** $version
          - **Tipo de mudanÃ§a:** $changeType
          - **Branch:** $branch
          - **Executor:** $actor
          - **Timestamp:** $timestamp
          - **Run ID:** $runId
          
          ## ğŸ” Status dos Jobs
          
          - **Versionamento:** ${{ inputs.version_updated }}
          - **Release:** ${{ inputs.release_success }}
          - **Patch:** ${{ inputs.patch_success }}
          
          ## ğŸ”— Links Ãšteis
          
          - [Pipeline Run](https://github.com/${{ github.repository }}/actions/runs/$runId)
          - [Logs Completos](https://github.com/${{ github.repository }}/actions/runs/$runId)
          
          ## ğŸ› ï¸ PrÃ³ximos Passos
          
          1. Revisar logs da pipeline
          2. Identificar causa raiz
          3. Corrigir problema
          4. Re-executar pipeline
          5. Fechar esta issue apÃ³s resoluÃ§Ã£o
          
          ---
          
          **Issue criada automaticamente pela pipeline em $timestamp**
          "@
          
          try {
            # Verificar se GitHub CLI estÃ¡ disponÃ­vel
            if (Get-Command gh -ErrorAction SilentlyContinue) {
              
              # Criar issue
              $issueArgs = @(
                "issue", "create",
                "--title", $issueTitle,
                "--body", $issueBody,
                "--label", "bug,pipeline,automated"
              )
              
              & gh @issueArgs
              
              if ($LASTEXITCODE -eq 0) {
                Write-Output "âœ… Issue criada automaticamente"
              } else {
                Write-Output "âŒ Erro ao criar issue via CLI"
              }
              
            } else {
              Write-Output "âš ï¸ GitHub CLI nÃ£o disponÃ­vel, issue nÃ£o criada"
              Write-Output "ğŸ’¡ Issue body preparada:"
              Write-Output $issueBody
            }
            
          } catch {
            Write-Output "âŒ Erro na criaÃ§Ã£o da issue: $_"
            Write-Output "ğŸ’¡ Issue seria criada com:"
            Write-Output "TÃ­tulo: $issueTitle"
            Write-Output "Corpo: $issueBody"
          }

      - name: Performance Metrics
        shell: powershell
        run: |
          Write-Output "ğŸ“Š Coletando mÃ©tricas da pipeline..."
          
          $startTime = "${{ github.event.head_commit.timestamp }}"
          $endTime = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
          $action = "${{ inputs.action }}"
          $success = "${{ steps.summary.outputs.overall-success }}"
          
          try {
            # Calcular duraÃ§Ã£o aproximada (limitaÃ§Ã£o: nÃ£o temos timestamp exato do inÃ­cio)
            Write-Output "â±ï¸ MÃ©tricas de Performance:"
            Write-Output "  â€¢ AÃ§Ã£o executada: $action"
            Write-Output "  â€¢ Status: $(if ($success -eq "true") { "âœ… Sucesso" } else { "âŒ Falha" })"
            Write-Output "  â€¢ Commit timestamp: $startTime"
            Write-Output "  â€¢ Pipeline end: $endTime"
            Write-Output "  â€¢ Branch: ${{ github.ref_name }}"
            Write-Output "  â€¢ Trigger: ${{ github.event_name }}"
            
            # MÃ©tricas especÃ­ficas por tipo
            if ($action -eq "release") {
              Write-Output "ğŸ“¦ MÃ©tricas de Release:"
              Write-Output "  â€¢ Versionamento: ${{ inputs.version_updated }}"
              Write-Output "  â€¢ Shorebird release: ${{ inputs.release_success }}"
              Write-Output "  â€¢ VersÃ£o: ${{ inputs.version }}"
            } elseif ($action -eq "patch") {
              Write-Output "ğŸ”§ MÃ©tricas de Patch:"
              Write-Output "  â€¢ Versionamento: ${{ inputs.version_updated }}"
              Write-Output "  â€¢ Shorebird patch: ${{ inputs.patch_success }}"
              Write-Output "  â€¢ VersÃ£o: ${{ inputs.version }}"
            }
            
          } catch {
            Write-Output "âš ï¸ Erro ao coletar mÃ©tricas: $_"
          }

      - name: Cleanup and Recommendations
        shell: powershell
        run: |
          Write-Output "ğŸ§¹ Limpeza e recomendaÃ§Ãµes finais..."
          
          $action = "${{ inputs.action }}"
          $success = "${{ steps.summary.outputs.overall-success }}"
          $version = "${{ inputs.version }}"
          
          Write-Output ""
          Write-Output "ğŸ“‹ RECOMENDAÃ‡Ã•ES PÃ“S-PIPELINE:"
          Write-Output "=============================="
          
          if ($success -eq "true") {
            Write-Output "âœ… Pipeline executada com sucesso!"
            Write-Output ""
            
            if ($action -eq "release") {
              Write-Output "ğŸš€ Para Release v$version:"
              Write-Output "  1. ğŸ“Š Monitorar adoÃ§Ã£o nos prÃ³ximos dias"
              Write-Output "  2. ğŸ§ª Testar atualizaÃ§Ã£o em ambiente de teste"
              Write-Output "  3. ğŸ“± Verificar funcionamento em dispositivos reais"
              Write-Output "  4. ğŸ“ˆ Acompanhar mÃ©tricas de crash/performance"
              Write-Output "  5. ğŸ“ Documentar mudanÃ§as para usuÃ¡rios finais"
              
            } elseif ($action -eq "patch") {
              Write-Output "ğŸ”§ Para Patch v$version:"
              Write-Output "  1. â³ Aguardar 10-15 minutos para propagaÃ§Ã£o completa"
              Write-Output "  2. ğŸ“± Testar update em app instalado"
              Write-Output "  3. ğŸ” Verificar logs de update dos usuÃ¡rios"
              Write-Output "  4. ğŸ“Š Monitorar mÃ©tricas de adoÃ§Ã£o"
              Write-Output "  5. ğŸš¨ Estar pronto para rollback se necessÃ¡rio"
            }
            
            Write-Output ""
            Write-Output "ğŸ› ï¸ Comandos Ãºteis:"
            Write-Output "  shorebird releases list"
            Write-Output "  shorebird patches list"
            Write-Output "  shorebird doctor"
            
          } else {
            Write-Output "âŒ Pipeline falhou!"
            Write-Output ""
            Write-Output "ğŸ”§ AÃ§Ãµes de recuperaÃ§Ã£o:"
            Write-Output "  1. ğŸ“‹ Revisar logs detalhados desta execuÃ§Ã£o"
            Write-Output "  2. ğŸ” Executar: shorebird doctor"
            Write-Output "  3. ğŸ› ï¸ Corrigir problemas identificados"
            Write-Output "  4. ğŸ”„ Re-executar pipeline manualmente"
            Write-Output "  5. ğŸ’¬ Buscar suporte se problema persistir"
            Write-Output ""
            Write-Output "ğŸ“ Recursos de ajuda:"
            Write-Output "  â€¢ DocumentaÃ§Ã£o Shorebird: https://docs.shorebird.dev"
            Write-Output "  â€¢ GitHub Actions logs: Actions â†’ Run ${{ github.run_id }}"
            Write-Output "  â€¢ Issue automÃ¡tica criada para tracking"
          }
          
          Write-Output ""
          Write-Output "ğŸ¯ LEMBRETE IMPORTANTE:"
          Write-Output "  Esta pipeline Ã© 100% automÃ¡tica!"
          Write-Output "  Apenas faÃ§a commits seguindo convenÃ§Ãµes e deixe a automaÃ§Ã£o trabalhar!"
          Write-Output ""
          Write-Output "=============================="

      - name: Final Status
        shell: powershell
        run: |
          $success = "${{ steps.summary.outputs.overall-success }}"
          $action = "${{ inputs.action }}"
          $version = "${{ inputs.version }}"
          
          if ($success -eq "true") {
            Write-Output ""
            Write-Output "ğŸ‰ğŸ‰ğŸ‰ PIPELINE 100% AUTOMÃTICA CONCLUÃDA COM SUCESSO! ğŸ‰ğŸ‰ğŸ‰"
            Write-Output ""
            Write-Output "âœ¨ $action v$version disponÃ­vel via Shorebird!"
            Write-Output "ğŸš€ UsuÃ¡rios receberÃ£o atualizaÃ§Ãµes automaticamente!"
            Write-Output "ğŸ¯ Zero trabalho manual necessÃ¡rio!"
            Write-Output ""
            exit 0
          } else {
            Write-Output ""
            Write-Output "âŒâŒâŒ PIPELINE FALHOU - REQUER ATENÃ‡ÃƒO âŒâŒâŒ"
            Write-Output ""
            Write-Output "ğŸ” Verifique logs e issue automÃ¡tica criada"
            Write-Output "ğŸ› ï¸ Corrija problemas e re-execute"
            Write-Output ""
            exit 1
          }