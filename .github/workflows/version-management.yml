name: Version Management

on:
  workflow_call:
    inputs:
      current_version:
        description: "VersÃ£o atual"
        required: true
        type: string
      new_version:
        description: "Nova versÃ£o"
        required: true
        type: string
      change_type:
        description: "Tipo de mudanÃ§a"
        required: true
        type: string
      release_notes:
        description: "Notas da release"
        required: true
        type: string
    outputs:
      version-updated:
        description: "VersÃ£o foi atualizada"
        value: ${{ jobs.update-version.outputs.version-updated }}
      changelog-updated:
        description: "Changelog foi atualizado"
        value: ${{ jobs.update-version.outputs.changelog-updated }}
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  update-version:
    runs-on: windows-latest
    outputs:
      version-updated: ${{ steps.update-pubspec.outputs.version-updated }}
      changelog-updated: ${{ steps.update-changelog.outputs.changelog-updated }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        shell: powershell
        run: |
          Write-Output "âš™ï¸ Configurando Git para commits automÃ¡ticos..."
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action Bot"
          git config --global core.longpaths true

      - name: Update pubspec.yaml
        id: update-pubspec
        shell: powershell
        run: |
          $currentVersion = "${{ inputs.current_version }}"
          $newVersion = "${{ inputs.new_version }}"
          
          Write-Output "ğŸ“ Atualizando pubspec.yaml..."
          Write-Output "  De: $currentVersion"
          Write-Output "  Para: $newVersion"
          
          try {
            # Ler conteÃºdo atual
            $pubspecContent = Get-Content pubspec.yaml -Raw -ErrorAction Stop
            
            # Fazer backup
            $backupContent = $pubspecContent
            
            # Atualizar versÃ£o
            $updatedContent = $pubspecContent -replace "version:\s*.+", "version: $newVersion"
            
            # Verificar se houve mudanÃ§a
            if ($pubspecContent -eq $updatedContent) {
              Write-Output "â„¹ï¸ Nenhuma mudanÃ§a necessÃ¡ria no pubspec.yaml"
              echo "version-updated=false" >> $env:GITHUB_OUTPUT
              return
            }
            
            # Salvar arquivo atualizado
            Set-Content pubspec.yaml $updatedContent -Encoding UTF8
            
            # Verificar se arquivo foi realmente modificado
            $hasChanges = git diff --name-only pubspec.yaml
            
            if ($hasChanges) {
              Write-Output "âœ… pubspec.yaml atualizado com sucesso"
              echo "version-updated=true" >> $env:GITHUB_OUTPUT
              
              # Mostrar diff para debug
              Write-Output "ğŸ“‹ MudanÃ§as realizadas:"
              git diff pubspec.yaml | Write-Output
            } else {
              Write-Output "âš ï¸ Arquivo nÃ£o foi modificado pelo Git"
              echo "version-updated=false" >> $env:GITHUB_OUTPUT
            }
            
          } catch {
            Write-Output "âŒ Erro ao atualizar pubspec.yaml: $_"
            
            # Restaurar backup se houver erro
            if ($backupContent) {
              Set-Content pubspec.yaml $backupContent -Encoding UTF8
              Write-Output "â†©ï¸ Backup restaurado"
            }
            
            echo "version-updated=false" >> $env:GITHUB_OUTPUT
            throw "Falha na atualizaÃ§Ã£o do pubspec.yaml"
          }

      - name: Update CHANGELOG.md
        id: update-changelog
        shell: powershell
        run: |
          $newVersion = "${{ inputs.new_version }}"
          $changeType = "${{ inputs.change_type }}"
          $releaseNotes = @"
          ${{ inputs.release_notes }}
          "@
          
          Write-Output "ğŸ“ Atualizando CHANGELOG.md..."
          
          try {
            $date = Get-Date -Format "yyyy-MM-dd"
            $changeTypeEmoji = switch ($changeType) {
              "major" { "ğŸ’¥" }
              "minor" { "âœ¨" }
              "patch" { "ğŸ›" }
              default { "ğŸ“" }
            }
            
            # Criar entrada do changelog
            $changelogEntry = @"
            
            ## [$changeTypeEmoji $newVersion] - $date
            
            $releaseNotes
            
            "@
            
            # Verificar se CHANGELOG.md existe
            if (Test-Path "CHANGELOG.md") {
              Write-Output "ğŸ“‹ CHANGELOG.md encontrado, atualizando..."
              
              $existingChangelog = Get-Content "CHANGELOG.md" -Raw -ErrorAction Stop
              
              # Inserir nova entrada apÃ³s o cabeÃ§alho
              if ($existingChangelog -like "*# Changelog*") {
                $newChangelog = $existingChangelog -replace "(# Changelog)", "`$1$changelogEntry"
              } else {
                $newChangelog = "# Changelog$changelogEntry$existingChangelog"
              }
            } else {
              Write-Output "ğŸ“‹ Criando novo CHANGELOG.md..."
              
              $newChangelog = @"
              # Changelog
              
              Todas as mudanÃ§as importantes do projeto sÃ£o documentadas neste arquivo.
              
              O formato Ã© baseado em [Keep a Changelog](https://keepachangelog.com/),
              e este projeto adere ao [Semantic Versioning](https://semver.org/).
              $changelogEntry
              "@
            }
            
            # Salvar changelog atualizado
            Set-Content "CHANGELOG.md" $newChangelog -Encoding UTF8
            
            # Verificar se foi modificado
            $changelogModified = git diff --name-only CHANGELOG.md
            
            if ($changelogModified) {
              Write-Output "âœ… CHANGELOG.md atualizado com sucesso"
              echo "changelog-updated=true" >> $env:GITHUB_OUTPUT
              
              # Mostrar preview da entrada adicionada
              Write-Output "ğŸ“‹ Nova entrada adicionada:"
              Write-Output $changelogEntry
            } else {
              Write-Output "â„¹ï¸ CHANGELOG.md nÃ£o foi modificado"
              echo "changelog-updated=false" >> $env:GITHUB_OUTPUT
            }
            
          } catch {
            Write-Output "âŒ Erro ao atualizar CHANGELOG.md: $_"
            echo "changelog-updated=false" >> $env:GITHUB_OUTPUT
            # NÃ£o falhar a pipeline por erro no changelog
          }

      - name: Commit Version Changes
        if: steps.update-pubspec.outputs.version-updated == 'true'
        shell: powershell
        run: |
          $newVersion = "${{ inputs.new_version }}"
          $changeType = "${{ inputs.change_type }}"
          
          Write-Output "ğŸ’¾ Fazendo commit das mudanÃ§as de versÃ£o..."
          
          try {
            # Adicionar arquivos modificados
            git add pubspec.yaml
            
            if ("${{ steps.update-changelog.outputs.changelog-updated }}" -eq "true") {
              git add CHANGELOG.md
              Write-Output "ğŸ“‹ CHANGELOG.md incluÃ­do no commit"
            }
            
            # Verificar se hÃ¡ mudanÃ§as para commitar
            $stagedChanges = git diff --cached --name-only
            
            if (-not $stagedChanges) {
              Write-Output "â„¹ï¸ Nenhuma mudanÃ§a para commitar"
              return
            }
            
            Write-Output "ğŸ“‹ Arquivos que serÃ£o commitados:"
            $stagedChanges | ForEach-Object { Write-Output "  - $_" }
            
            # Fazer commit com mensagem apropriada
            $commitMessage = "chore: bump version to $newVersion [$changeType] [skip ci]"
            git commit -m $commitMessage
            
            Write-Output "âœ… Commit realizado: $commitMessage"
            
            # Push das mudanÃ§as
            Write-Output "ğŸ“¤ Enviando mudanÃ§as para repositÃ³rio remoto..."
            git push origin HEAD
            
            Write-Output "âœ… MudanÃ§as enviadas com sucesso"
            
          } catch {
            Write-Output "âŒ Erro no commit/push: $_"
            
            # Reset se houver erro
            git reset --hard HEAD
            Write-Output "â†©ï¸ Reset realizado devido ao erro"
            
            throw "Falha no commit das mudanÃ§as de versÃ£o"
          }

      - name: Validate Version Update
        if: steps.update-pubspec.outputs.version-updated == 'true'
        shell: powershell
        run: |
          $expectedVersion = "${{ inputs.new_version }}"
          
          Write-Output "ğŸ” Validando atualizaÃ§Ã£o de versÃ£o..."
          
          try {
            # Verificar se a versÃ£o foi realmente atualizada
            $pubspecContent = Get-Content pubspec.yaml -Raw
            $versionMatch = $pubspecContent | Select-String 'version:\s*(.+)'
            
            if ($versionMatch) {
              $actualVersion = $versionMatch.Matches[0].Groups[1].Value.Trim()
              
              if ($actualVersion -eq $expectedVersion) {
                Write-Output "âœ… VersÃ£o validada com sucesso: $actualVersion"
              } else {
                Write-Output "âŒ VersÃ£o nÃ£o confere!"
                Write-Output "  Esperada: $expectedVersion"
                Write-Output "  Atual: $actualVersion"
                throw "ValidaÃ§Ã£o de versÃ£o falhou"
              }
            } else {
              Write-Output "âŒ NÃ£o foi possÃ­vel encontrar versÃ£o no pubspec.yaml"
              throw "VersÃ£o nÃ£o encontrada apÃ³s atualizaÃ§Ã£o"
            }
            
          } catch {
            Write-Output "âŒ Erro na validaÃ§Ã£o: $_"
            throw "Falha na validaÃ§Ã£o da versÃ£o"
          }

      - name: Summary
        shell: powershell
        run: |
          Write-Output ""
          Write-Output "ğŸ“‹ RESUMO DO VERSIONAMENTO"
          Write-Output "=========================="
          Write-Output "ğŸ“± VersÃ£o: ${{ inputs.current_version }} â†’ ${{ inputs.new_version }}"
          Write-Output "ğŸ“ pubspec.yaml: ${{ steps.update-pubspec.outputs.version-updated }}"
          Write-Output "ğŸ“‹ CHANGELOG.md: ${{ steps.update-changelog.outputs.changelog-updated }}"
          Write-Output "ğŸ“Š Tipo: ${{ inputs.change_type }}"
          Write-Output "=========================="
          
          if ("${{ steps.update-pubspec.outputs.version-updated }}" -eq "true") {
            Write-Output "âœ… Versionamento concluÃ­do com sucesso!"
          } else {
            Write-Output "â„¹ï¸ Nenhuma atualizaÃ§Ã£o de versÃ£o necessÃ¡ria"
          }