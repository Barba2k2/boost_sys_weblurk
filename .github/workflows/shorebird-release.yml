name: Shorebird Release

on:
  workflow_call:
    inputs:
      version:
        description: "VersÃ£o da release"
        required: true
        type: string
      release_notes:
        description: "Notas da release"
        required: true
        type: string
    outputs:
      release-created:
        description: "Release foi criada"
        value: ${{ jobs.create-release.outputs.release-created }}
      tag-created:
        description: "Tag foi criada"
        value: ${{ jobs.create-release.outputs.tag-created }}
      github-release-created:
        description: "GitHub release foi criada"
        value: ${{ jobs.create-release.outputs.github-release-created }}
    secrets:
      SHOREBIRD_TOKEN:
        required: true

jobs:
  create-release:
    runs-on: windows-latest
    outputs:
      release-created: ${{ steps.shorebird-release.outputs.release-created }}
      tag-created: ${{ steps.git-tag.outputs.tag-created }}
      github-release-created: ${{ steps.github-release.outputs.github-release-created }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          cache: true

      - name: Setup Shorebird
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      - name: Verify Shorebird Configuration
        shell: powershell
        run: |
          Write-Output "ğŸ” Verificando configuraÃ§Ã£o do Shorebird..."
          
          try {
            # Verificar versÃ£o
            $shorebirdVersion = shorebird --version
            Write-Output "âœ… Shorebird versÃ£o: $shorebirdVersion"
            
            # Verificar configuraÃ§Ã£o do app
            Write-Output "ğŸ“‹ Verificando configuraÃ§Ã£o do app..."
            shorebird apps list
            
            # Verificar releases existentes
            Write-Output "ğŸ“‹ Releases existentes:"
            try {
              shorebird releases list | head -10
            } catch {
              Write-Output "â„¹ï¸ Nenhuma release encontrada ou erro ao listar"
            }
            
          } catch {
            Write-Output "âŒ Erro na verificaÃ§Ã£o do Shorebird: $_"
            throw "ConfiguraÃ§Ã£o do Shorebird invÃ¡lida"
          }
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: Install Dependencies
        shell: powershell
        run: |
          Write-Output "ğŸ“¦ Instalando dependÃªncias Flutter..."
          
          try {
            flutter pub get
            Write-Output "âœ… DependÃªncias instaladas com sucesso"
            
            # Verificar se hÃ¡ problemas
            flutter analyze --no-fatal-infos --no-fatal-warnings
            Write-Output "âœ… AnÃ¡lise de cÃ³digo concluÃ­da"
            
          } catch {
            Write-Output "âš ï¸ Aviso durante instalaÃ§Ã£o de dependÃªncias: $_"
            # NÃ£o falhar a pipeline por warnings menores
          }

      - name: Pre-Release Validation
        shell: powershell
        run: |
          $version = "${{ inputs.version }}"
          
          Write-Output "ğŸ” ValidaÃ§Ã£o prÃ©-release..."
          Write-Output "  VersÃ£o: $version"
          
          # Verificar se a versÃ£o jÃ¡ existe
          try {
            $existingReleases = shorebird releases list --json 2>$null
            
            if ($existingReleases) {
              $releases = $existingReleases | ConvertFrom-Json
              $existingVersion = $releases | Where-Object { $_.version -eq $version }
              
              if ($existingVersion) {
                Write-Output "âš ï¸ Release $version jÃ¡ existe no Shorebird"
                Write-Output "ğŸ“‹ Release existente:"
                $existingVersion | ConvertTo-Json -Depth 2 | Write-Output
                throw "Release $version jÃ¡ existe"
              } else {
                Write-Output "âœ… VersÃ£o $version Ã© Ãºnica"
              }
            } else {
              Write-Output "âœ… Primeira release do projeto"
            }
          } catch {
            if ($_.Exception.Message -like "*jÃ¡ existe*") {
              throw
            }
            Write-Output "âš ï¸ NÃ£o foi possÃ­vel verificar releases existentes: $_"
            Write-Output "ğŸ”„ Continuando com a criaÃ§Ã£o..."
          }
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: Create Shorebird Release
        id: shorebird-release
        shell: powershell
        run: |
          $version = "${{ inputs.version }}"
          
          Write-Output "ğŸš€ Criando release Shorebird para Windows..."
          Write-Output "  VersÃ£o: $version"
          Write-Output "  Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          
          try {
            # Criar release com verbose para debug
            $releaseOutput = shorebird release windows --verbose 2>&1
            
            Write-Output "ğŸ“‹ Output da criaÃ§Ã£o da release:"
            $releaseOutput | Write-Output
            
            # Verificar se a release foi criada com sucesso
            if ($LASTEXITCODE -eq 0) {
              Write-Output "âœ… Release Shorebird criada com sucesso!"
              echo "release-created=true" >> $env:GITHUB_OUTPUT
              
              # Listar releases para confirmaÃ§Ã£o
              Write-Output "ğŸ“‹ Releases atuais:"
              shorebird releases list | head -5
              
            } else {
              Write-Output "âŒ Falha na criaÃ§Ã£o da release (Exit code: $LASTEXITCODE)"
              echo "release-created=false" >> $env:GITHUB_OUTPUT
              throw "Shorebird release falhou"
            }
            
          } catch {
            Write-Output "âŒ Erro durante criaÃ§Ã£o da release: $_"
            echo "release-created=false" >> $env:GITHUB_OUTPUT
            
            # Tentar obter mais informaÃ§Ãµes sobre o erro
            try {
              Write-Output "ğŸ” DiagnÃ³stico adicional:"
              shorebird doctor
            } catch {
              Write-Output "âš ï¸ NÃ£o foi possÃ­vel executar diagnÃ³stico"
            }
            
            throw "Falha na criaÃ§Ã£o da release Shorebird"
          }
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: Create Git Tag
        id: git-tag
        if: steps.shorebird-release.outputs.release-created == 'true'
        shell: powershell
        run: |
          $version = "${{ inputs.version }}"
          $tag = "v$version"
          
          Write-Output "ğŸ·ï¸ Criando tag Git: $tag"
          
          try {
            # Configurar Git
            git config --global user.email "action@github.com"
            git config --global user.name "GitHub Action Bot"
            
            # Verificar se tag jÃ¡ existe
            $existingTag = git tag -l $tag
            
            if ($existingTag) {
              Write-Output "âš ï¸ Tag $tag jÃ¡ existe"
              Write-Output "ğŸ—‘ï¸ Removendo tag existente..."
              
              # Remover tag local e remota
              git tag -d $tag 2>$null
              git push origin --delete $tag 2>$null
            }
            
            # Criar nova tag
            $tagMessage = "Release $tag - Auto-generated by Shorebird Pipeline"
            git tag -a $tag -m $tagMessage
            
            Write-Output "âœ… Tag local criada: $tag"
            
            # Push da tag
            git push origin $tag
            
            Write-Output "âœ… Tag enviada para repositÃ³rio remoto"
            echo "tag-created=true" >> $env:GITHUB_OUTPUT
            
          } catch {
            Write-Output "âŒ Erro na criaÃ§Ã£o da tag: $_"
            echo "tag-created=false" >> $env:GITHUB_OUTPUT
            
            # NÃ£o falhar a pipeline apenas por erro na tag
            Write-Output "âš ï¸ Continuando sem tag Git..."
          }

      - name: Create GitHub Release
        id: github-release
        if: steps.shorebird-release.outputs.release-created == 'true'
        shell: powershell
        run: |
          $version = "${{ inputs.version }}"
          $tag = "v$version"
          $releaseNotes = @"
          ${{ inputs.release_notes }}
          "@
          
          Write-Output "ğŸ“ Criando GitHub Release..."
          Write-Output "  Tag: $tag"
          Write-Output "  VersÃ£o: $version"
          
          try {
            # Preparar corpo da release
            $releaseBody = @"
            # ğŸš€ Boost SysWebLurk $version
            
            **Release automÃ¡tica gerada pelo Shorebird Pipeline**
            
            $releaseNotes
            
            ## ğŸ“¦ Como Atualizar
            
            ### Para UsuÃ¡rios Existentes:
            1. ğŸ”„ Abra o aplicativo instalado
            2. â³ Aguarde a detecÃ§Ã£o automÃ¡tica de atualizaÃ§Ãµes (30-60 segundos)
            3. âœ… Aceite a atualizaÃ§Ã£o quando solicitado
            4. ğŸ‰ Aplicativo serÃ¡ reiniciado com a nova versÃ£o
            
            ### Para Novos UsuÃ¡rios:
            - ğŸ“¥ Baixe o instalador mais recente dos assets desta release
            - ğŸ”§ Execute o instalador e siga as instruÃ§Ãµes
            - ğŸš€ O aplicativo jÃ¡ estarÃ¡ na versÃ£o mais recente
            
            ## ğŸ”§ Tecnologia
            
            Esta release utiliza **Shorebird Code Push** para atualizaÃ§Ãµes automÃ¡ticas:
            - âš¡ Updates instantÃ¢neos sem reinstalaÃ§Ã£o
            - ğŸ›¡ï¸ Rollback automÃ¡tico em caso de problemas  
            - ğŸ“Š AtualizaÃ§Ãµes incrementais menores
            
            ---
            
            **ğŸ¤– Gerado automaticamente em $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') UTC**
            
            **ğŸ“‹ Pipeline:** Shorebird Release Automation  
            **ğŸ”§ Plataforma:** Windows x64  
            **ğŸ“± VersÃ£o anterior:** Verificar CHANGELOG.md para detalhes
            "@
            
            # Usar GitHub CLI para criar release (mais confiÃ¡vel que API direta)
            $releaseArgs = @(
              "release", "create", $tag,
              "--title", "Boost SysWebLurk $version",
              "--notes", $releaseBody,
              "--latest"
            )
            
            # Verificar se GitHub CLI estÃ¡ disponÃ­vel
            if (Get-Command gh -ErrorAction SilentlyContinue) {
              Write-Output "âœ… GitHub CLI encontrado, criando release..."
              
              & gh @releaseArgs
              
              if ($LASTEXITCODE -eq 0) {
                Write-Output "âœ… GitHub Release criada com sucesso!"
                echo "github-release-created=true" >> $env:GITHUB_OUTPUT
              } else {
                Write-Output "âŒ Erro ao criar GitHub Release via CLI"
                echo "github-release-created=false" >> $env:GITHUB_OUTPUT
              }
              
            } else {
              Write-Output "âš ï¸ GitHub CLI nÃ£o disponÃ­vel"
              Write-Output "ğŸ“ Release notes preparadas:"
              Write-Output $releaseBody
              echo "github-release-created=false" >> $env:GITHUB_OUTPUT
            }
            
          } catch {
            Write-Output "âŒ Erro na criaÃ§Ã£o do GitHub Release: $_"
            echo "github-release-created=false" >> $env:GITHUB_OUTPUT
            
            # NÃ£o falhar a pipeline apenas por erro no GitHub Release
            Write-Output "âš ï¸ Continuando sem GitHub Release..."
          }

      - name: Post-Release Validation
        if: steps.shorebird-release.outputs.release-created == 'true'
        shell: powershell
        run: |
          $version = "${{ inputs.version }}"
          
          Write-Output "ğŸ” ValidaÃ§Ã£o pÃ³s-release..."
          
          try {
            # Verificar se a release aparece na lista
            $releases = shorebird releases list --json 2>$null
            
            if ($releases) {
              $releasesList = $releases | ConvertFrom-Json
              $createdRelease = $releasesList | Where-Object { $_.version -eq $version }
              
              if ($createdRelease) {
                Write-Output "âœ… Release $version confirmada no Shorebird"
                Write-Output "ğŸ“‹ Detalhes da release:"
                $createdRelease | ConvertTo-Json -Depth 2 | Write-Output
              } else {
                Write-Output "âš ï¸ Release $version nÃ£o encontrada na lista"
              }
            } else {
              Write-Output "âš ï¸ NÃ£o foi possÃ­vel validar releases"
            }
            
            # Verificar patches disponÃ­veis para esta release
            Write-Output "ğŸ“‹ Patches disponÃ­veis para esta release:"
            try {
              shorebird patches list --release-version=$version 2>$null
            } catch {
              Write-Output "â„¹ï¸ Nenhum patch ainda para esta release (esperado)"
            }
            
          } catch {
            Write-Output "âš ï¸ Erro na validaÃ§Ã£o pÃ³s-release: $_"
            # NÃ£o falhar por erro de validaÃ§Ã£o
          }
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: Summary
        shell: powershell
        run: |
          Write-Output ""
          Write-Output "ğŸ“‹ RESUMO DA RELEASE"
          Write-Output "==================="
          Write-Output "ğŸš€ VersÃ£o: ${{ inputs.version }}"
          Write-Output "ğŸ“¦ Shorebird Release: ${{ steps.shorebird-release.outputs.release-created }}"
          Write-Output "ğŸ·ï¸ Git Tag: ${{ steps.git-tag.outputs.tag-created }}"
          Write-Output "ğŸ“ GitHub Release: ${{ steps.github-release.outputs.github-release-created }}"
          Write-Output "â° ConcluÃ­do em: $(Get-Date -Format 'HH:mm:ss')"
          Write-Output "==================="
          
          if ("${{ steps.shorebird-release.outputs.release-created }}" -eq "true") {
            Write-Output ""
            Write-Output "ğŸ‰ RELEASE CRIADA COM SUCESSO!"
            Write-Output ""
            Write-Output "ğŸ“‹ PrÃ³ximos passos:"
            Write-Output "  1. âœ… Release base disponÃ­vel no Shorebird"
            Write-Output "  2. ğŸ”§ Patches futuros serÃ£o baseados nesta release"
            Write-Output "  3. ğŸ“± UsuÃ¡rios podem receber atualizaÃ§Ãµes automÃ¡ticas"
            Write-Output "  4. ğŸ” Monitorar logs de atualizaÃ§Ã£o dos usuÃ¡rios"
            Write-Output ""
          } else {
            Write-Output ""
            Write-Output "âŒ FALHA NA CRIAÃ‡ÃƒO DA RELEASE"
            Write-Output "âš ï¸ Verifique logs acima para detalhes do erro"
            Write-Output ""
          }