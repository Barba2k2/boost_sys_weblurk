name: Shorebird Patch

on:
  workflow_call:
    inputs:
      version:
        description: "VersÃ£o do patch"
        required: true
        type: string
      change_type:
        description: "Tipo de mudanÃ§a"
        required: true
        type: string
    outputs:
      patch-created:
        description: "Patch foi criado"
        value: ${{ jobs.create-patch.outputs.patch-created }}
      target-release:
        description: "Release base do patch"
        value: ${{ jobs.create-patch.outputs.target-release }}
      patch-number:
        description: "NÃºmero do patch"
        value: ${{ jobs.create-patch.outputs.patch-number }}
    secrets:
      SHOREBIRD_TOKEN:
        required: true

jobs:
  create-patch:
    runs-on: windows-latest
    outputs:
      patch-created: ${{ steps.shorebird-patch.outputs.patch-created }}
      target-release: ${{ steps.target-release.outputs.target-release }}
      patch-number: ${{ steps.shorebird-patch.outputs.patch-number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          cache: true

      - name: Setup Shorebird
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      - name: Verify Shorebird Configuration
        shell: powershell
        run: |
          Write-Output "ğŸ” Verificando configuraÃ§Ã£o do Shorebird para patches..."
          
          try {
            # Verificar versÃ£o
            $shorebirdVersion = shorebird --version
            Write-Output "âœ… Shorebird versÃ£o: $shorebirdVersion"
            
            # Verificar se hÃ¡ releases disponÃ­veis
            Write-Output "ğŸ“‹ Verificando releases disponÃ­veis..."
            $releases = shorebird releases list 2>$null
            
            if (-not $releases) {
              Write-Output "âŒ Nenhuma release encontrada!"
              Write-Output "âš ï¸ Ã‰ necessÃ¡rio ter pelo menos uma release base para criar patches"
              throw "Nenhuma release base disponÃ­vel"
            }
            
            Write-Output "âœ… Releases encontradas:"
            $releases | head -5 | Write-Output
            
          } catch {
            Write-Output "âŒ Erro na verificaÃ§Ã£o do Shorebird: $_"
            throw "ConfiguraÃ§Ã£o do Shorebird invÃ¡lida para patches"
          }
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: Install Dependencies
        shell: powershell
        run: |
          Write-Output "ğŸ“¦ Instalando dependÃªncias Flutter..."
          
          try {
            flutter pub get
            Write-Output "âœ… DependÃªncias instaladas com sucesso"
            
            # VerificaÃ§Ã£o rÃ¡pida sem bloquear por warnings
            Write-Output "ğŸ” VerificaÃ§Ã£o rÃ¡pida do cÃ³digo..."
            flutter analyze --no-fatal-warnings 2>$null
            Write-Output "âœ… CÃ³digo verificado"
            
          } catch {
            Write-Output "âš ï¸ Aviso durante preparaÃ§Ã£o: $_"
            # Patches podem ser mais tolerantes a warnings
          }

      - name: Determine Target Release
        id: target-release
        shell: powershell
        run: |
          Write-Output "ğŸ¯ Determinando release base para o patch..."
          
          try {
            # Buscar releases disponÃ­veis
            $releasesJson = shorebird releases list --json 2>$null
            
            if ($releasesJson) {
              $releases = $releasesJson | ConvertFrom-Json
              
              if ($releases -and $releases.Count -gt 0) {
                # Pegar a release mais recente
                $latestRelease = $releases[0]
                $targetVersion = $latestRelease.version
                $releaseDate = $latestRelease.created_at
                
                Write-Output "âœ… Release base encontrada:"
                Write-Output "  VersÃ£o: $targetVersion"
                Write-Output "  Data: $releaseDate"
                
                # Verificar patches existentes para esta release
                try {
                  $existingPatches = shorebird patches list --release-version=$targetVersion --json 2>$null
                  
                  if ($existingPatches) {
                    $patches = $existingPatches | ConvertFrom-Json
                    $patchCount = $patches.Count
                    Write-Output "ğŸ“‹ Patches existentes para esta release: $patchCount"
                  } else {
                    Write-Output "ğŸ“‹ Nenhum patch existente para esta release"
                  }
                } catch {
                  Write-Output "âš ï¸ NÃ£o foi possÃ­vel verificar patches existentes"
                }
                
              } else {
                # Fallback para versÃ£o padrÃ£o
                $targetVersion = "1.0.14+2"
                Write-Output "âš ï¸ Lista de releases vazia, usando fallback: $targetVersion"
              }
              
            } else {
              # Fallback para versÃ£o padrÃ£o
              $targetVersion = "1.0.14+2"
              Write-Output "âš ï¸ Erro ao buscar releases, usando fallback: $targetVersion"
            }
            
            echo "target-release=$targetVersion" >> $env:GITHUB_OUTPUT
            Write-Output "ğŸ¯ Release alvo para patch: $targetVersion"
            
          } catch {
            # Ãšltimo fallback
            $targetVersion = "1.0.14+2"
            Write-Output "âŒ Erro na determinaÃ§Ã£o da release base: $_"
            Write-Output "ğŸ”„ Usando fallback final: $targetVersion"
            echo "target-release=$targetVersion" >> $env:GITHUB_OUTPUT
          }
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: Pre-Patch Validation
        shell: powershell
        run: |
          $version = "${{ inputs.version }}"
          $targetRelease = "${{ steps.target-release.outputs.target-release }}"
          $changeType = "${{ inputs.change_type }}"
          
          Write-Output "ğŸ” ValidaÃ§Ã£o prÃ©-patch..."
          Write-Output "  VersÃ£o do patch: $version"
          Write-Output "  Release base: $targetRelease"
          Write-Output "  Tipo de mudanÃ§a: $changeType"
          
          # Verificar se o tipo de mudanÃ§a Ã© apropriado para patch
          if ($changeType -eq "major") {
            Write-Output "âš ï¸ MudanÃ§a major detectada, mas criando patch conforme solicitado"
            Write-Output "ğŸ’¡ Considere criar uma release ao invÃ©s de patch para mudanÃ§as major"
          } elseif ($changeType -eq "minor") {
            Write-Output "âš ï¸ MudanÃ§a minor detectada, mas criando patch conforme solicitado"
            Write-Output "ğŸ’¡ Patches sÃ£o ideais para mudanÃ§as patch (bug fixes, melhorias pequenas)"
          } else {
            Write-Output "âœ… Tipo de mudanÃ§a apropriado para patch"
          }
          
          # Verificar se a release base existe
          try {
            $releases = shorebird releases list --json 2>$null | ConvertFrom-Json
            $targetReleaseExists = $releases | Where-Object { $_.version -eq $targetRelease }
            
            if ($targetReleaseExists) {
              Write-Output "âœ… Release base $targetRelease confirmada"
            } else {
              Write-Output "âš ï¸ Release base $targetRelease nÃ£o encontrada na lista"
              Write-Output "ğŸ”„ Prosseguindo com tentativa de criaÃ§Ã£o..."
            }
          } catch {
            Write-Output "âš ï¸ NÃ£o foi possÃ­vel validar release base: $_"
          }
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: Create Shorebird Patch
        id: shorebird-patch
        shell: powershell
        run: |
          $version = "${{ inputs.version }}"
          $targetRelease = "${{ steps.target-release.outputs.target-release }}"
          $changeType = "${{ inputs.change_type }}"
          
          Write-Output "ğŸ”§ Criando patch Shorebird para Windows..."
          Write-Output "  VersÃ£o do patch: $version"
          Write-Output "  Release base: $targetRelease"
          Write-Output "  Tipo: $changeType"
          Write-Output "  Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          
          try {
            # Criar patch com verbose para debug
            if ($targetRelease -and $targetRelease -ne "") {
              Write-Output "ğŸ¯ Criando patch para release especÃ­fica: $targetRelease"
              $patchOutput = shorebird patch windows --release-version=$targetRelease --verbose 2>&1
            } else {
              Write-Output "ğŸ¯ Criando patch para release mais recente"
              $patchOutput = shorebird patch windows --verbose 2>&1
            }
            
            Write-Output "ğŸ“‹ Output da criaÃ§Ã£o do patch:"
            $patchOutput | Write-Output
            
            # Verificar sucesso
            if ($LASTEXITCODE -eq 0) {
              Write-Output "âœ… Patch Shorebird criado com sucesso!"
              echo "patch-created=true" >> $env:GITHUB_OUTPUT
              
              # Tentar extrair nÃºmero do patch do output
              $patchNumberMatch = $patchOutput | Select-String "Patch (\d+)" | Select-Object -First 1
              if ($patchNumberMatch) {
                $patchNumber = $patchNumberMatch.Matches[0].Groups[1].Value
                echo "patch-number=$patchNumber" >> $env:GITHUB_OUTPUT
                Write-Output "ğŸ“Š NÃºmero do patch: $patchNumber"
              } else {
                echo "patch-number=unknown" >> $env:GITHUB_OUTPUT
                Write-Output "ğŸ“Š NÃºmero do patch: nÃ£o identificado"
              }
              
            } else {
              Write-Output "âŒ Falha na criaÃ§Ã£o do patch (Exit code: $LASTEXITCODE)"
              echo "patch-created=false" >> $env:GITHUB_OUTPUT
              echo "patch-number=failed" >> $env:GITHUB_OUTPUT
              throw "Shorebird patch falhou"
            }
            
          } catch {
            Write-Output "âŒ Erro durante criaÃ§Ã£o do patch: $_"
            echo "patch-created=false" >> $env:GITHUB_OUTPUT
            echo "patch-number=error" >> $env:GITHUB_OUTPUT
            
            # Tentar diagnÃ³stico adicional
            try {
              Write-Output "ğŸ” DiagnÃ³stico adicional:"
              shorebird doctor 2>$null
              
              Write-Output "ğŸ“‹ Status das releases:"
              shorebird releases list 2>$null | head -3
              
            } catch {
              Write-Output "âš ï¸ NÃ£o foi possÃ­vel executar diagnÃ³stico adicional"
            }
            
            throw "Falha na criaÃ§Ã£o do patch Shorebird"
          }
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: Post-Patch Validation
        if: steps.shorebird-patch.outputs.patch-created == 'true'
        shell: powershell
        run: |
          $targetRelease = "${{ steps.target-release.outputs.target-release }}"
          $patchNumber = "${{ steps.shorebird-patch.outputs.patch-number }}"
          
          Write-Output "ğŸ” ValidaÃ§Ã£o pÃ³s-patch..."
          
          try {
            # Verificar se o patch aparece na lista
            Write-Output "ğŸ“‹ Verificando patches para release $targetRelease..."
            
            $patches = shorebird patches list --release-version=$targetRelease 2>$null
            
            if ($patches) {
              Write-Output "âœ… Patches encontrados para release $targetRelease:"
              $patches | Write-Output
              
              # Verificar se nosso patch especÃ­fico estÃ¡ lÃ¡
              if ($patchNumber -and $patchNumber -ne "unknown" -and $patchNumber -ne "failed") {
                $patchFound = $patches | Select-String "Patch $patchNumber"
                if ($patchFound) {
                  Write-Output "âœ… Patch $patchNumber confirmado na lista"
                } else {
                  Write-Output "âš ï¸ Patch $patchNumber nÃ£o encontrado na lista ainda"
                }
              }
              
            } else {
              Write-Output "âš ï¸ Nenhum patch encontrado (pode ser delay na propagaÃ§Ã£o)"
            }
            
            # Listar todos os patches para debug
            Write-Output "ğŸ“‹ Todos os patches do projeto:"
            try {
              shorebird patches list 2>$null | head -10
            } catch {
              Write-Output "âš ï¸ NÃ£o foi possÃ­vel listar todos os patches"
            }
            
          } catch {
            Write-Output "âš ï¸ Erro na validaÃ§Ã£o pÃ³s-patch: $_"
            # NÃ£o falhar por erro de validaÃ§Ã£o
          }
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: Patch Distribution Info
        if: steps.shorebird-patch.outputs.patch-created == 'true'
        shell: powershell
        run: |
          $version = "${{ inputs.version }}"
          $targetRelease = "${{ steps.target-release.outputs.target-release }}"
          $patchNumber = "${{ steps.shorebird-patch.outputs.patch-number }}"
          
          Write-Output ""
          Write-Output "ğŸ“¡ INFORMAÃ‡Ã•ES DE DISTRIBUIÃ‡ÃƒO"
          Write-Output "=============================="
          Write-Output "ğŸ¯ Patch criado e pronto para distribuiÃ§Ã£o!"
          Write-Output ""
          Write-Output "ğŸ“‹ Detalhes do Patch:"
          Write-Output "  ğŸ“¦ VersÃ£o: $version"
          Write-Output "  ğŸ—ï¸ Release base: $targetRelease"
          Write-Output "  ğŸ”¢ NÃºmero do patch: $patchNumber"
          Write-Output "  â° Criado em: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Output ""
          Write-Output "ğŸ“± Como os usuÃ¡rios receberÃ£o:"
          Write-Output "  1. ğŸ”„ UsuÃ¡rios com release $targetRelease instalada"
          Write-Output "  2. ğŸ“¥ ReceberÃ£o update automÃ¡tico na prÃ³xima abertura do app"
          Write-Output "  3. â³ DetecÃ§Ã£o em 30-60 segundos apÃ³s abrir o app"
          Write-Output "  4. ğŸ’¾ Download do patch (tipicamente < 1MB)"
          Write-Output "  5. ğŸ”„ AplicaÃ§Ã£o automÃ¡tica apÃ³s aceitar o update"
          Write-Output ""
          Write-Output "ğŸ” Monitoramento:"
          Write-Output "  â€¢ Verificar logs de update nos dispositivos dos usuÃ¡rios"
          Write-Output "  â€¢ Acompanhar mÃ©tricas no Shorebird dashboard"
          Write-Output "  â€¢ Monitorar crash reports apÃ³s distribuiÃ§Ã£o"
          Write-Output ""
          Write-Output "ğŸ› ï¸ Comandos Ãºteis:"
          Write-Output "  shorebird patches list --release-version=$targetRelease"
          Write-Output "  shorebird releases list"
          Write-Output "=============================="

      - name: Summary
        shell: powershell
        run: |
          Write-Output ""
          Write-Output "ğŸ“‹ RESUMO DO PATCH"
          Write-Output "=================="
          Write-Output "ğŸ”§ VersÃ£o: ${{ inputs.version }}"
          Write-Output "ğŸ¯ Release base: ${{ steps.target-release.outputs.target-release }}"
          Write-Output "ğŸ“¦ Patch criado: ${{ steps.shorebird-patch.outputs.patch-created }}"
          Write-Output "ğŸ”¢ NÃºmero: ${{ steps.shorebird-patch.outputs.patch-number }}"
          Write-Output "ğŸ“Š Tipo: ${{ inputs.change_type }}"
          Write-Output "â° ConcluÃ­do em: $(Get-Date -Format 'HH:mm:ss')"
          Write-Output "=================="
          
          if ("${{ steps.shorebird-patch.outputs.patch-created }}" -eq "true") {
            Write-Output ""
            Write-Output "ğŸ‰ PATCH CRIADO COM SUCESSO!"
            Write-Output ""
            Write-Output "ğŸ“‹ PrÃ³ximos passos automÃ¡ticos:"
            Write-Output "  1. âœ… Patch disponÃ­vel no Shorebird"
            Write-Output "  2. ğŸ“¡ DistribuiÃ§Ã£o automÃ¡tica para usuÃ¡rios"
            Write-Output "  3. ğŸ”„ Updates automÃ¡ticos na prÃ³xima abertura do app"
            Write-Output "  4. ğŸ“Š Monitoramento de adoÃ§Ã£o disponÃ­vel"
            Write-Output ""
            Write-Output "ğŸ¯ UsuÃ¡rios alvo:"
            Write-Output "  â€¢ Dispositivos com release ${{ steps.target-release.outputs.target-release }}"
            Write-Output "  â€¢ Aplicativo instalado e funcional"
            Write-Output "  â€¢ ConexÃ£o com internet ativa"
            Write-Output ""
          } else {
            Write-Output ""
            Write-Output "âŒ FALHA NA CRIAÃ‡ÃƒO DO PATCH"
            Write-Output "âš ï¸ Verifique logs acima para detalhes do erro"
            Write-Output ""
          }