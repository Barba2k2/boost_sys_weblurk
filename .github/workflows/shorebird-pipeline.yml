name: Shorebird Main Pipeline

on:
  push:
    branches:
      - "1.0.14+1"
      - "main"
      - "master"
    paths-ignore:
      - "README.md"
      - "docs/**"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/pull_request_template.md"
  
  # Adicionar trigger manual para debug
  workflow_dispatch:
    inputs:
      force_run:
        description: "For√ßar execu√ß√£o da pipeline"
        required: false
        default: true
        type: boolean

# Adicionar permiss√µes necess√°rias
permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

env:
  SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

jobs:
  # Job de verifica√ß√£o inicial
  debug-trigger:
    runs-on: windows-latest
    steps:
      - name: Debug Pipeline Trigger
        shell: powershell
        run: |
          Write-Output "üîç DEBUG: Pipeline foi disparada!"
          Write-Output "üìã Informa√ß√µes do trigger:"
          Write-Output "  Branch: ${{ github.ref_name }}"
          Write-Output "  Event: ${{ github.event_name }}"
          Write-Output "  SHA: ${{ github.sha }}"
          Write-Output "  Actor: ${{ github.actor }}"
          Write-Output "  Workflow: ${{ github.workflow }}"
          Write-Output "  Repository: ${{ github.repository }}"
          
          Write-Output "üìÅ Arquivos modificados neste push:"
          try {
            $changedFiles = git diff --name-only HEAD~1..HEAD
            if ($changedFiles) {
              $changedFiles | ForEach-Object { Write-Output "  - $_" }
            } else {
              Write-Output "  (Nenhum arquivo detectado ou primeiro commit)"
            }
          } catch {
            Write-Output "  (Erro ao obter arquivos modificados)"
          }
          
          Write-Output "üîê Verifica√ß√£o de secrets:"
          if ("${{ secrets.SHOREBIRD_TOKEN }}" -ne "") {
            Write-Output "  ‚úÖ SHOREBIRD_TOKEN configurado"
          } else {
            Write-Output "  ‚ùå SHOREBIRD_TOKEN N√ÉO configurado"
          }

  # Job 1: An√°lise de Mudan√ßas
  analyze:
    needs: debug-trigger
    uses: ./.github/workflows/analyze-changes.yml
    with:
      branch_name: ${{ github.ref_name }}
    secrets:
      SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

  # Job 2: Versionamento (se necess√°rio)
  versioning:
    needs: analyze
    if: needs.analyze.outputs.should-proceed == 'true'
    uses: ./.github/workflows/version-management.yml
    with:
      current_version: ${{ needs.analyze.outputs.current-version }}
      new_version: ${{ needs.analyze.outputs.new-version }}
      change_type: ${{ needs.analyze.outputs.change-type }}
      release_notes: ${{ needs.analyze.outputs.release-notes }}

  # Job 3: Shorebird Release (se for release)
  shorebird-release:
    needs: [analyze, versioning]
    if: needs.analyze.outputs.action == 'release'
    uses: ./.github/workflows/shorebird-release.yml
    with:
      version: ${{ needs.analyze.outputs.new-version }}
      release_notes: ${{ needs.analyze.outputs.release-notes }}
    secrets:
      SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

  # Job 4: Shorebird Patch (se for patch)
  shorebird-patch:
    needs: [analyze, versioning]
    if: needs.analyze.outputs.action == 'patch'
    uses: ./.github/workflows/shorebird-patch.yml
    with:
      version: ${{ needs.analyze.outputs.new-version }}
      change_type: ${{ needs.analyze.outputs.change-type }}
    secrets:
      SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

  # Job 5: Notifica√ß√µes e Cleanup
  notify:
    needs: [analyze, versioning, shorebird-release, shorebird-patch]
    if: always()
    uses: ./.github/workflows/notify-results.yml
    with:
      action: ${{ needs.analyze.outputs.action }}
      version: ${{ needs.analyze.outputs.new-version }}
      change_type: ${{ needs.analyze.outputs.change-type }}
      release_success: ${{ needs.shorebird-release.result == 'success' }}
      patch_success: ${{ needs.shorebird-patch.result == 'success' }}
      version_updated: ${{ needs.versioning.outputs.version-updated }}