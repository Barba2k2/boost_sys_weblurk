name: Analyze Changes

on:
  workflow_call:
    inputs:
      branch_name:
        description: "Nome da branch"
        required: true
        type: string
    outputs:
      action:
        description: "Ação a ser executada (release/patch)"
        value: ${{ jobs.analyze.outputs.action }}
      current-version:
        description: "Versão atual"
        value: ${{ jobs.analyze.outputs.current-version }}
      new-version:
        description: "Nova versão"
        value: ${{ jobs.analyze.outputs.new-version }}
      should-proceed:
        description: "Deve prosseguir com pipeline"
        value: ${{ jobs.analyze.outputs.should-proceed }}
      change-type:
        description: "Tipo de mudança (major/minor/patch)"
        value: ${{ jobs.analyze.outputs.change-type }}
      release-notes:
        description: "Notas da release"
        value: ${{ jobs.analyze.outputs.release-notes }}
    secrets:
      SHOREBIRD_TOKEN:
        required: true

jobs:
  analyze:
    runs-on: windows-latest
    outputs:
      action: ${{ steps.decision.outputs.action }}
      current-version: ${{ steps.version.outputs.current-version }}
      new-version: ${{ steps.version.outputs.new-version }}
      should-proceed: ${{ steps.decision.outputs.should-proceed }}
      change-type: ${{ steps.analyze.outputs.change-type }}
      release-notes: ${{ steps.analyze.outputs.release-notes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Shorebird (for verification)
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      - name: Analyze Code Changes
        id: analyze
        shell: powershell
        run: |
          Write-Output "🔍 Analisando mudanças no código..."
          
          # Analisar commits desde o último push
          $commits = git log --oneline -10 --format="%s"
          $changedFiles = git diff --name-only HEAD~1..HEAD
          
          Write-Output "📝 Commits recentes:"
          $commits | ForEach-Object { Write-Output "  - $_" }
          
          Write-Output "📁 Arquivos modificados:"
          $changedFiles | ForEach-Object { Write-Output "  - $_" }
          
          # Inicializar flags de análise
          $isBreakingChange = $false
          $isMajorFeature = $false
          $hasNewDependencies = $false
          $hasNativeChanges = $false
          $hasInfraChanges = $false
          $isPatchOnly = $true
          
          # Analisar arquivos modificados
          foreach ($file in $changedFiles) {
            switch -Regex ($file) {
              "^pubspec\.yaml$" { 
                $hasNewDependencies = $true
                $isPatchOnly = $false
                Write-Output "  📦 Dependências detectadas"
              }
              "^(android|ios|windows|macos|linux)/" { 
                $hasNativeChanges = $true
                $isPatchOnly = $false
                Write-Output "  🔧 Mudanças nativas detectadas"
              }
              "^lib/main\.dart$|^lib/core/di/" { 
                $hasInfraChanges = $true
                $isPatchOnly = $false
                Write-Output "  🏗️ Mudanças de infraestrutura detectadas"
              }
              "^\.github/workflows/" {
                $hasInfraChanges = $true
                Write-Output "  ⚙️ Mudanças de CI/CD detectadas"
              }
            }
          }
          
          # Analisar commits para padrões
          foreach ($commit in $commits) {
            switch -Regex ($commit) {
              "(BREAKING|!:)" { 
                $isBreakingChange = $true
                $isPatchOnly = $false
                Write-Output "  💥 Breaking change detectado: $commit"
              }
              "^(feat|feature):" { 
                $isMajorFeature = $true
                $isPatchOnly = $false
                Write-Output "  ✨ Nova feature detectada: $commit"
              }
              "^(fix|bugfix):" {
                Write-Output "  🐛 Bug fix detectado: $commit"
              }
              "^(style|refactor|perf|docs):" {
                Write-Output "  🔧 Melhoria detectada: $commit"
              }
            }
          }
          
          # Determinar tipo de mudança
          if ($isBreakingChange) {
            $changeType = "major"
            Write-Output "📊 Resultado: MAJOR RELEASE (breaking change)"
          } elseif ($isMajorFeature -or $hasNewDependencies -or $hasNativeChanges) {
            $changeType = "minor"
            Write-Output "📊 Resultado: MINOR RELEASE (nova feature/dependência)"
          } else {
            $changeType = "patch"
            Write-Output "📊 Resultado: PATCH (correção/melhoria)"
          }
          
          # Gerar notas da release
          $releaseNotes = @()
          $releaseNotes += "### Mudanças nesta versão"
          $releaseNotes += ""
          
          foreach ($commit in $commits) {
            if ($commit -notlike "*chore:*" -and $commit -notlike "*docs:*") {
              $icon = switch -Regex ($commit) {
                "^feat" { "✨" }
                "^fix" { "🐛" }
                "^perf" { "⚡" }
                "^style" { "💄" }
                "^refactor" { "♻️" }
                default { "📝" }
              }
              $releaseNotes += "- $icon $commit"
            }
          }
          
          $releaseNotesText = $releaseNotes -join "`n"
          
          # Set outputs
          echo "change-type=$changeType" >> $env:GITHUB_OUTPUT
          echo "is-patch-only=$isPatchOnly" >> $env:GITHUB_OUTPUT
          echo "has-breaking-changes=$isBreakingChange" >> $env:GITHUB_OUTPUT
          echo "has-new-dependencies=$hasNewDependencies" >> $env:GITHUB_OUTPUT
          echo "has-native-changes=$hasNativeChanges" >> $env:GITHUB_OUTPUT
          
          echo "release-notes<<EOF" >> $env:GITHUB_OUTPUT
          echo $releaseNotesText >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT

      - name: Get Current Version
        id: version
        shell: powershell
        run: |
          Write-Output "📋 Obtendo versão atual do pubspec.yaml..."
          
          try {
            $pubspecContent = Get-Content pubspec.yaml -Raw -ErrorAction Stop
            $versionMatch = $pubspecContent | Select-String 'version:\s*(.+)'
            
            if ($versionMatch) {
              $currentVersion = $versionMatch.Matches[0].Groups[1].Value.Trim()
              Write-Output "✅ Versão atual encontrada: $currentVersion"
            } else {
              $currentVersion = "1.0.14+2"
              Write-Output "⚠️ Versão não encontrada no pubspec.yaml, usando fallback: $currentVersion"
            }
          } catch {
            $currentVersion = "1.0.14+2"
            Write-Output "❌ Erro ao ler pubspec.yaml, usando fallback: $currentVersion"
          }
          
          # Parse da versão atual
          $versionParts = $currentVersion -split '\+'
          $semverParts = $versionParts[0] -split '\.'
          $buildNumber = if ($versionParts.Length -gt 1) { [int]$versionParts[1] } else { 1 }
          
          try {
            $major = [int]$semverParts[0]
            $minor = [int]$semverParts[1]
            $patch = [int]$semverParts[2]
          } catch {
            Write-Output "❌ Erro ao parsear versão, usando valores padrão"
            $major = 1
            $minor = 0
            $patch = 14
            $buildNumber = 2
          }
          
          # Calcular nova versão baseada no tipo de mudança
          $changeType = "${{ steps.analyze.outputs.change-type }}"
          
          switch ($changeType) {
            "major" { 
              $major += 1
              $minor = 0
              $patch = 0
              $buildNumber += 1
              Write-Output "📈 Major version bump: $major.0.0+$buildNumber"
            }
            "minor" { 
              $minor += 1
              $patch = 0
              $buildNumber += 1
              Write-Output "📈 Minor version bump: $major.$minor.0+$buildNumber"
            }
            "patch" { 
              $patch += 1
              $buildNumber += 1
              Write-Output "📈 Patch version bump: $major.$minor.$patch+$buildNumber"
            }
            default { 
              $patch += 1
              $buildNumber += 1
              Write-Output "📈 Default patch bump: $major.$minor.$patch+$buildNumber"
            }
          }
          
          $newVersion = "$major.$minor.$patch+$buildNumber"
          
          # Override manual se fornecido
          if ("${{ inputs.force_version }}" -ne "") {
            $newVersion = "${{ inputs.force_version }}"
            Write-Output "🎯 Usando versão forçada: $newVersion"
          }
          
          echo "current-version=$currentVersion" >> $env:GITHUB_OUTPUT
          echo "new-version=$newVersion" >> $env:GITHUB_OUTPUT
          
          Write-Output "📊 Versionamento final:"
          Write-Output "  Atual: $currentVersion"
          Write-Output "  Nova: $newVersion"
          Write-Output "  Tipo: $changeType"

      - name: Determine Action
        id: decision
        shell: powershell
        run: |
          Write-Output "🎯 Determinando ação da pipeline..."
          
          $changeType = "${{ steps.analyze.outputs.change-type }}"
          $isPatchOnly = "${{ steps.analyze.outputs.is-patch-only }}"
          $branch = "${{ inputs.branch_name }}"
          
          Write-Output "📋 Parâmetros de decisão:"
          Write-Output "  Branch: $branch"
          Write-Output "  Tipo de mudança: $changeType"
          Write-Output "  Apenas patch: $isPatchOnly"
          
          # Lógica 100% automática de decisão
          if ($branch -eq "1.0.14+1") {
            $action = "patch"
            Write-Output "🔧 Branch de patches detectada → PATCH"
          } elseif ($changeType -eq "major" -or $changeType -eq "minor") {
            $action = "release"
            Write-Output "🚀 Mudança significativa detectada → RELEASE"
          } elseif ($isPatchOnly -eq "true") {
            $action = "patch"
            Write-Output "🔧 Apenas mudanças pequenas → PATCH"
          } else {
            $action = "release"
            Write-Output "🚀 Mudanças diversas → RELEASE (seguro)"
          }
          
          # Verificar se deve prosseguir
          $shouldProceed = "true"
          
          # Verificações de sanidade
          try {
            $env:SHOREBIRD_TOKEN = "${{ secrets.SHOREBIRD_TOKEN }}"
            shorebird doctor 2>$null
            Write-Output "✅ Shorebird configurado corretamente"
          } catch {
            Write-Output "⚠️ Problema na configuração do Shorebird"
            # Não falhar, apenas avisar
          }
          
          echo "action=$action" >> $env:GITHUB_OUTPUT
          echo "should-proceed=$shouldProceed" >> $env:GITHUB_OUTPUT
          
          Write-Output "📊 Decisão final:"
          Write-Output "  Ação: $action"
          Write-Output "  Deve prosseguir: $shouldProceed"
          Write-Output "  Versão alvo: ${{ steps.version.outputs.new-version }}"

      - name: Summary
        shell: powershell
        run: |
          Write-Output ""
          Write-Output "📋 RESUMO DA ANÁLISE"
          Write-Output "==================="
          Write-Output "🎯 Ação: ${{ steps.decision.outputs.action }}"
          Write-Output "📊 Tipo: ${{ steps.analyze.outputs.change-type }}"
          Write-Output "📱 Versão: ${{ steps.version.outputs.current-version }} → ${{ steps.version.outputs.new-version }}"
          Write-Output "🌟 Branch: ${{ inputs.branch_name }}"
          Write-Output "✅ Prosseguir: ${{ steps.decision.outputs.should-proceed }}"
          Write-Output "==================="